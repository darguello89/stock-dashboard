<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Dashboard - Trading Analyzer</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --tertiary-bg: #334155;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #475569;
        }
        
        * {
            color-scheme: dark;
        }
        
        body {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }
        
        /* Greeting Section */
        .greeting-section {
            background: linear-gradient(135deg, var(--secondary-bg) 0%, var(--tertiary-bg) 100%);
            padding: 3rem 2rem;
            border-bottom: 2px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .greeting-title {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-green), #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .time-display {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .market-sentiment {
            background-color: var(--secondary-bg);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border-left: 4px solid var(--accent-green);
            margin-top: 1.5rem;
        }
        
        .sentiment-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .sentiment-bullish {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }
        
        .sentiment-bearish {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }
        
        .sentiment-neutral {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
            border: 1px solid var(--accent-yellow);
        }
        
        /* News Carousel Section */
        .news-section {
            padding: 3rem 2rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            padding-bottom: 1rem;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), #3b82f6);
        }
        
        .news-card {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            height: 100%;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .news-card:hover {
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
            transform: translateY(-5px);
        }
        
        .news-source {
            display: inline-block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-green);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }
        
        .news-headline {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            line-height: 1.4;
            color: var(--text-primary);
        }
        
        .news-excerpt {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .affected-stocks {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .stock-tag {
            display: inline-block;
            background-color: var(--tertiary-bg);
            padding: 0.35rem 0.75rem;
            border-radius: 0.35rem;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid var(--border-color);
        }
        
        .stock-tag.positive {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }
        
        .stock-tag.negative {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }
        
        .stock-tag.neutral {
            border-color: var(--text-secondary);
            color: var(--text-secondary);
        }
        
        .news-timestamp {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 1rem;
            font-style: italic;
        }
        
        /* Stocks List Section */
        .stocks-section {
            padding: 3rem 2rem;
        }
        
        .stocks-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background-color: var(--accent-green);
            border-color: var(--accent-green);
            color: var(--primary-bg);
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        
        .search-box input {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
        }
        
        .search-box input::placeholder {
            color: var(--text-secondary);
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
        }
        
        .stocks-table {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        .stocks-table thead {
            background-color: var(--tertiary-bg);
            border-bottom: 2px solid var(--border-color);
        }
        
        .stocks-table th {
            padding: 1.25rem;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        
        .stocks-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }
        
        .stocks-table tbody tr:hover {
            background-color: var(--tertiary-bg);
        }
        
        .stocks-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .stocks-table td {
            padding: 1.25rem;
            font-size: 0.95rem;
        }
        
        .stock-symbol {
            font-weight: 700;
            color: var(--accent-green);
            font-size: 1rem;
        }
        
        .stock-price {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .price-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .price-change.positive {
            color: var(--accent-green);
        }
        
        .price-change.negative {
            color: var(--accent-red);
        }
        
        .rating-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            min-width: 120px;
        }
        
        .rating-strong-buy {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }
        
        .rating-buy {
            background-color: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }
        
        .rating-hold {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
            border: 1px solid var(--accent-yellow);
        }
        
        .rating-sell {
            background-color: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid #f87171;
        }
        
        .rating-strong-sell {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }
        
        .price-range {
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            border-radius: 0.35rem;
            font-size: 0.9rem;
            display: inline-block;
            white-space: nowrap;
        }
        
        .price-range-buy {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(16, 185, 129, 0.4);
        }
        
        .price-range-sell {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.4);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .greeting-title {
                font-size: 2rem;
            }
            
            .stocks-table {
                font-size: 0.85rem;
            }
            
            .stocks-table th,
            .stocks-table td {
                padding: 0.75rem 0.5rem;
            }
            
            .stocks-controls {
                flex-direction: column;
            }
            
            .filter-btn {
                width: 100%;
            }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .greeting-section,
        .news-section,
        .stocks-section {
            animation: fadeIn 0.6s ease-out;
        }
    </style>
</head>
<body>
    <!-- Greeting Section -->
    <section class="greeting-section">
        <div class="container-fluid">
            <div class="time-display" id="timeDisplay"></div>
            <h1 class="greeting-title">
                <span id="greeting"></span>, Diego ðŸ‘‹
            </h1>
            
            <!-- Market Sentiment -->
            <div class="market-sentiment">
                <div style="margin-bottom: 1rem;">
                    <h5 style="margin-bottom: 0.75rem; color: var(--text-primary);">ðŸ“Š Market Sentiment</h5>
                    <p style="margin: 0; color: var(--text-secondary); line-height: 1.6;">
                        <span id="sentimentText">Loading market sentiment...</span>
                    </p>
                </div>
                
                <div style="margin-top: 1rem;">
                    <span class="sentiment-badge sentiment-bullish">
                        <i class="bi bi-arrow-up"></i> Bullish (45%)
                    </span>
                    <span class="sentiment-badge sentiment-neutral">
                        <i class="bi bi-dash"></i> Neutral (35%)
                    </span>
                    <span class="sentiment-badge sentiment-bearish">
                        <i class="bi bi-arrow-down"></i> Bearish (20%)
                    </span>
                </div>
            </div>
        </div>
    </section>

    <!-- News Section with Carousel -->
    <section class="news-section">
        <div class="container-fluid">
            <h2 class="section-title">
                <i class="bi bi-newspaper"></i> Market News & Analysis
            </h2>
            
            <div class="row g-3" id="newsCarousel">
                <!-- News cards will be populated here dynamically -->
            </div>
        </div>
    </section>

    <!-- Stocks List Section -->
    <section class="stocks-section">
        <div class="container-fluid">
            <h2 class="section-title">
                <i class="bi bi-graph-up"></i> Top 100 US Stocks Analysis
            </h2>
            
            <!-- Controls -->
            <div class="stocks-controls">
                <button class="filter-btn active" onclick="filterStocks('all')">
                    <i class="bi bi-list"></i> All
                </button>
                <button class="filter-btn" onclick="filterStocks('strong-buy')">
                    <i class="bi bi-check-circle"></i> Strong Buy
                </button>
                <button class="filter-btn" onclick="filterStocks('buy')">
                    <i class="bi bi-arrow-up-circle"></i> Buy
                </button>
                <button class="filter-btn" onclick="filterStocks('hold')">
                    <i class="bi bi-dash-circle"></i> Hold
                </button>
                <button class="filter-btn" onclick="filterStocks('sell')">
                    <i class="bi bi-arrow-down-circle"></i> Sell
                </button>
                <button class="filter-btn" onclick="filterStocks('strong-sell')">
                    <i class="bi bi-x-circle"></i> Strong Sell
                </button>
                
                <div class="search-box ms-auto">
                    <input type="text" id="stockSearch" placeholder="Search by symbol or company name..." onkeyup="searchStocks()">
                </div>
            </div>
            
            <!-- Stocks Table -->
            <div class="stocks-table">
                <table class="table table-hover mb-0" style="color: inherit;">
                    <thead>
                        <tr>
                            <th style="width: 8%;">Symbol</th>
                            <th style="width: 18%;">Company Name</th>
                            <th style="width: 10%;">Price</th>
                            <th style="width: 10%;">Change (24h)</th>
                            <th style="width: 10%;">P/E Ratio</th>
                            <th style="width: 12%;">Market Cap</th>
                            <th style="width: 13%;">Buy Range</th>
                            <th style="width: 13%;">Sell Range</th>
                            <th style="width: 16%;">Rating</th>
                        </tr>
                    </thead>
                    <tbody id="stocksTableBody">
                        <!-- Stock rows will be populated here dynamically -->
                    </tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_BASE = '/';
        const STOCK_SYMBOLS = [
            'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'TSLA', 'META', 'XOM', 'JNJ', 'JPM',
            'V', 'WMT', 'PG', 'UNH', 'BAC', 'MA', 'DIS', 'VZ', 'CSCO', 'INTC',
            'AMD', 'CRM', 'ADBE', 'IBM', 'TXN', 'QCOM', 'HON', 'LOW', 'CAT', 'GE',
            'BA', 'NFLX', 'PYPL', 'SPGI', 'SQ', 'UBER', 'LYFT', 'SNAP', 'PINS', 'ZM',
            'DOCU', 'TWLO', 'OKTA', 'WORKDAY', 'SLACK', 'MSTR', 'ROKU', 'TTWO', 'RBLX', 'SHOP',
            'CCI', 'ATVI', 'TMUS', 'DISH', 'CHTR', 'CMCSA', 'ROST', 'BJ', 'AZO', 'RH',
            'ETSY', 'DASH', 'O', 'STWD', 'MAR', 'HLT', 'OKE', 'CPRT', 'PLD', 'DRE',
            'PSA', 'EQR', 'AVB', 'ESS', 'ELS', 'EQC', 'ARE', 'SRC', 'RLJ', 'GDRX',
            'VICI', 'MGM', 'PEN', 'LPX', 'IRM', 'GPRE', 'AMT', 'EQIX', 'CORe', 'LAUR',
            'NRG', 'NEE', 'DUK', 'SO', 'AEP', 'XEL', 'SLG', 'DEI', 'SBAC', 'FSV'
        ];
        
        // Stock company mapping
        const stockCompanies = {
            'AAPL': 'Apple Inc.',
            'MSFT': 'Microsoft Corporation',
            'GOOGL': 'Alphabet Inc.',
            'AMZN': 'Amazon.com Inc.',
            'NVDA': 'NVIDIA Corporation',
            'TSLA': 'Tesla Inc.',
            'META': 'Meta Platforms Inc.',
            'XOM': 'Exxon Mobil Corporation',
            'JNJ': 'Johnson & Johnson',
            'JPM': 'JPMorgan Chase & Co.',
            'V': 'Visa Inc.',
            'WMT': 'Walmart Inc.',
            'PG': 'Procter & Gamble',
            'UNH': 'UnitedHealth Group',
            'BAC': 'Bank of America',
            'MA': 'Mastercard Inc.',
            'DIS': 'The Walt Disney Company',
            'VZ': 'Verizon Communications',
            'CSCO': 'Cisco Systems',
            'INTC': 'Intel Corporation',
            'AMD': 'Advanced Micro Devices',
            'CRM': 'Salesforce Inc.',
            'ADBE': 'Adobe Inc.',
            'IBM': 'International Business Machines',
            'TXN': 'Texas Instruments',
            'QCOM': 'QUALCOMM Incorporated',
            'HON': 'Honeywell International',
            'LOW': 'Lowe\'s Companies Inc.',
            'CAT': 'Caterpillar Inc.',
            'GE': 'General Electric',
            'BA': 'Boeing Company',
            'NFLX': 'Netflix Inc.',
            'PYPL': 'PayPal Holdings',
            'SPGI': 'S&P Global Inc.',
            'SQ': 'Block Inc.',
            'UBER': 'Uber Technologies',
            'LYFT': 'Lyft Inc.',
            'SNAP': 'Snap Inc.',
            'PINS': 'Pinterest Inc.',
            'ZM': 'Zoom Video Communications',
            'DOCU': 'DocuSign Inc.',
            'TWLO': 'Twilio Inc.',
            'OKTA': 'Okta Inc.',
            'WORKDAY': 'Workday Inc.',
            'SLACK': 'Slack Technologies',
            'MSTR': 'MicroStrategy Inc.',
            'ROKU': 'Roku Inc.',
            'TTWO': 'Take-Two Interactive',
            'RBLX': 'Roblox Corporation',
            'SHOP': 'Shopify Inc.',
            'CCI': 'Crown Castle International',
            'ATVI': 'Activision Blizzard',
            'TMUS': 'T-Mobile US Inc.',
            'DISH': 'DISH Network Corporation',
            'CHTR': 'Charter Communications',
            'CMCSA': 'Comcast Corporation',
            'ROST': 'Ross Stores Inc.',
            'BJ': 'BJ\'s Wholesale Club',
            'AZO': 'AutoZone Inc.',
            'RH': 'RH (Restoration Hardware)',
            'ETSY': 'Etsy Inc.',
            'DASH': 'DoorDash Inc.',
            'O': 'Realty Income Corporation',
            'STWD': 'Starwood Property Trust',
            'MAR': 'Marriott International',
            'HLT': 'Hilton Worldwide Holdings',
            'OKE': 'ONEOK Inc.',
            'CPRT': 'Carpetright plc',
            'PLD': 'Prologis Inc.',
            'DRE': 'Duke Realty Corporation',
            'PSA': 'Public Storage',
            'EQR': 'Equity Residential',
            'AVB': 'AvalonBay Communities',
            'ESS': 'Essex Property Trust',
            'ELS': 'Equity Lifestyle Properties',
            'EQC': 'Equinix Inc.',
            'ARE': 'Alexandria Real Estate',
            'SRC': 'Srcb Inc.',
            'RLJ': 'RLJ Lodging Trust',
            'GDRX': 'GoodRx Holdings',
            'VICI': 'VICI Properties Inc.',
            'MGM': 'MGM Resorts International',
            'PEN': 'Penumbra Inc.',
            'LPX': 'Louisiana-Pacific Corporation',
            'IRM': 'Iron Mountain',
            'GPRE': 'Green Plains Inc.',
            'AMT': 'American Tower Corporation',
            'EQIX': 'Equinix Inc.',
            'LAUR': 'Laurentian Bank',
            'NRG': 'NRG Energy Inc.',
            'NEE': 'NextEra Energy',
            'DUK': 'Duke Energy Corporation',
            'SO': 'Southern Company',
            'AEP': 'American Electric Power',
            'XEL': 'Xcel Energy Inc.',
            'SLG': 'SL Green Realty Corp.',
            'DEI': 'Douglas Emmett Inc.',
            'SBAC': 'SBA Communications',
            'FSV': 'FirstService Corporation'
        };

        // Fetch stock data from backend API
        async function fetchStockData(symbol) {
            try {
                const response = await fetch(`${API_BASE}latest?symbol=${symbol}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching data for ${symbol}:`, error);
                return null;
            }
        }

        // Fetch news from backend API
        async function fetchNews() {
            try {
                const response = await fetch(`${API_BASE}news`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching news:', error);
                return null;
            }
        }

        // Get sentiment icon
        function getSentimentIcon(sentiment) {
            switch(sentiment) {
                case 'positive': return '<i class="bi bi-arrow-up-short"></i>';
                case 'negative': return '<i class="bi bi-arrow-down-short"></i>';
                case 'neutral': return '<i class="bi bi-dash"></i>';
                default: return '';
            }
        }

        // Update news section
        async function updateNews() {
            const data = await fetchNews();
            if (!data || !data.news) return;

            const newsContainer = document.getElementById('newsCarousel');
            newsContainer.innerHTML = '';

            data.news.forEach(item => {
                const stockTags = item.affected_stocks.map(stock => 
                    `<span class="stock-tag ${stock.sentiment}">${stock.symbol} ${getSentimentIcon(stock.sentiment)}</span>`
                ).join('');

                const newsCard = document.createElement('div');
                newsCard.className = 'col-md-6 col-lg-4 col-xl-3';
                newsCard.innerHTML = `
                    <div class="news-card">
                        <div class="news-source">
                            <i class="bi bi-newspaper"></i> ${item.source}
                        </div>
                        <h6 class="news-headline">${item.headline}</h6>
                        <p class="news-excerpt">
                            ${item.excerpt}
                        </p>
                        <div class="affected-stocks">
                            ${stockTags}
                        </div>
                        <div class="news-timestamp">${item.timestamp}</div>
                    </div>
                `;
                
                newsContainer.appendChild(newsCard);
            });
        }

        // Generate a signal rating based on RSI value
        function generateRating(rsi, ema20, price) {
            if (rsi < 30) {
                return 'STRONG BUY';
            } else if (rsi < 40) {
                return 'BUY';
            } else if (rsi > 70) {
                return 'STRONG SELL';
            } else if (rsi > 60) {
                return 'SELL';
            } else {
                return 'HOLD';
            }
        }

        // Generate price ranges based on current price and indicators
        function generatePriceRanges(price) {
            const buyRangeLow = Math.round(price * 0.92 * 100) / 100;
            const buyRangeHigh = Math.round(price * 0.98 * 100) / 100;
            const sellRangeLow = Math.round(price * 1.08 * 100) / 100;
            const sellRangeHigh = Math.round(price * 1.15 * 100) / 100;
            
            return {
                buy: `$${buyRangeLow} - $${buyRangeHigh}`,
                sell: `$${sellRangeLow} - $${sellRangeHigh}`
            };
        }

        // Get rating badge class
        function getRatingClass(rating) {
            switch(rating) {
                case 'STRONG BUY': return 'rating-strong-buy';
                case 'BUY': return 'rating-buy';
                case 'HOLD': return 'rating-hold';
                case 'SELL': return 'rating-sell';
                case 'STRONG SELL': return 'rating-strong-sell';
                default: return 'rating-hold';
            }
        }

        // Keep track of current stocks and rows for efficient updates
        let stockDataCache = new Map();
        let stockRowMap = new Map();

        // Update stocks table with real data
        async function updateStocksTable() {
            const tableBody = document.getElementById('stocksTableBody');
            const stocksData = [];

            for (const symbol of STOCK_SYMBOLS) {
                const data = await fetchStockData(symbol);
                
                if (!data || !data.snapshot) {
                    continue;
                }

                const snapshot = data.snapshot;
                const indicators = data.indicators || {};
                const rsi = indicators.rsi || 50;
                const ema20 = indicators.ema_20 || snapshot.price;
                const price = snapshot.price;
                
                const rating = generateRating(rsi, ema20, price);
                const priceRanges = generatePriceRanges(price);
                
                // Calculate a mock change percentage
                const changePercent = ((Math.random() - 0.4) * 5).toFixed(2);
                const isPositive = changePercent > 0;
                
                stocksData.push({
                    symbol,
                    company: stockCompanies[symbol] || symbol,
                    price,
                    changePercent: parseFloat(changePercent),
                    isPositive,
                    rating,
                    rsi,
                    priceRanges,
                    peRatio: (Math.random() * 50 + 10).toFixed(1),
                    marketCap: (Math.random() * 2 + 0.5).toFixed(1)
                });
            }

            // Sort by category order, then by recommendation strength within each category
            const categoryOrder = ['STRONG BUY', 'BUY', 'HOLD', 'SELL', 'STRONG SELL'];
            
            stocksData.sort((a, b) => {
                // First sort by category
                const categoryDiff = categoryOrder.indexOf(a.rating) - categoryOrder.indexOf(b.rating);
                if (categoryDiff !== 0) return categoryDiff;
                
                // Within same category, sort by recommendation confidence (RSI extremeness)
                if (a.rating === 'STRONG BUY' || a.rating === 'BUY') {
                    return a.rsi - b.rsi;
                } else if (a.rating === 'STRONG SELL' || a.rating === 'SELL') {
                    return b.rsi - a.rsi;
                } else {
                    return Math.abs(a.rsi - 50) - Math.abs(b.rsi - 50);
                }
            });

            // Update or create rows for each stock
            stocksData.forEach((stock, index) => {
                let row = stockRowMap.get(stock.symbol);
                
                if (!row) {
                    // Create new row if it doesn't exist
                    row = document.createElement('tr');
                    tableBody.appendChild(row);
                    stockRowMap.set(stock.symbol, row);
                }
                
                // Update row data only if values changed
                row.innerHTML = `
                    <td><span class="stock-symbol">${stock.symbol}</span></td>
                    <td>${stock.company}</td>
                    <td><span class="stock-price">$${stock.price.toFixed(2)}</span></td>
                    <td>
                        <span class="price-change ${stock.isPositive ? 'positive' : 'negative'}">
                            <i class="bi bi-arrow-${stock.isPositive ? 'up' : 'down'}-short"></i> ${stock.isPositive ? '+' : ''}${stock.changePercent.toFixed(2)}%
                        </span>
                    </td>
                    <td>${stock.peRatio}</td>
                    <td>$${stock.marketCap}T</td>
                    <td><span class="price-range price-range-buy">${stock.priceRanges.buy}</span></td>
                    <td><span class="price-range price-range-sell">${stock.priceRanges.sell}</span></td>
                    <td>
                        <span class="rating-badge ${getRatingClass(stock.rating)}">
                            ${stock.rating}
                        </span>
                    </td>
                `;
            });

            // Clean up rows for stocks no longer in data
            const currentSymbols = new Set(stocksData.map(s => s.symbol));
            const toRemove = [];
            
            stockRowMap.forEach((row, symbol) => {
                if (!currentSymbols.has(symbol)) {
                    row.remove();
                    toRemove.push(symbol);
                }
            });
            
            toRemove.forEach(symbol => stockRowMap.delete(symbol));
        }

        // Update greeting based on time of day
        function updateGreeting() {
            const now = new Date();
            const hour = now.getHours();
            let greeting = '';
            
            if (hour < 12) {
                greeting = 'Good Morning';
            } else if (hour < 18) {
                greeting = 'Good Afternoon';
            } else {
                greeting = 'Good Evening';
            }
            
            document.getElementById('greeting').textContent = greeting;
            
            // Update time display
            const timeString = now.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('timeDisplay').textContent = 'ðŸ“… ' + timeString;
        }
        
        // Update market sentiment (placeholder)
        function updateMarketSentiment() {
            const sentiments = [
                'Markets are showing strong bullish momentum with major indices climbing on Fed policy expectations and strong corporate earnings.',
                'Today\'s market activity reflects investor confidence in technology stocks and financial sector strength.',
                'Mixed sentiment dominates today\'s trading as investors balance growth concerns with inflation data.'
            ];
            
            const randomIndex = Math.floor(Math.random() * sentiments.length);
            document.getElementById('sentimentText').textContent = sentiments[randomIndex];
        }
        
        // Filter stocks by rating
        function filterStocks(rating) {
            // Update button active state
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter table rows
            const tableRows = document.querySelectorAll('#stocksTableBody tr');
            tableRows.forEach(row => {
                if (rating === 'all') {
                    row.style.display = '';
                } else {
                    const ratingBadge = row.querySelector('.rating-badge').textContent.trim();
                    const showRow = ratingBadge.includes(rating.toUpperCase().replace('-', ' '));
                    row.style.display = showRow ? '' : 'none';
                }
            });
        }
        
        // Search stocks
        function searchStocks() {
            const searchTerm = document.getElementById('stockSearch').value.toLowerCase();
            const tableRows = document.querySelectorAll('#stocksTableBody tr');
            
            tableRows.forEach(row => {
                const symbol = row.querySelector('.stock-symbol').textContent.toLowerCase();
                const company = row.cells[1].textContent.toLowerCase();
                
                if (symbol.includes(searchTerm) || company.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', function() {
            updateGreeting();
            updateMarketSentiment();
            updateNews();
            updateStocksTable();
            
            // Update time every second
            setInterval(updateGreeting, 1000);
            
            // Update news every 5 seconds (same as stocks)
            setInterval(updateNews, 5000);
            
            // Update stocks data every 5 seconds
            setInterval(updateStocksTable, 5000);
        });
    </script>
</body>
</html>